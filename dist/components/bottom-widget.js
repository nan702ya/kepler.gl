"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FilterAnimationControllerFactory = FilterAnimationControllerFactory;
exports.LayerAnimationControllerFactory = LayerAnimationControllerFactory;
exports["default"] = BottomWidgetFactory;

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _react = _interopRequireWildcard(require("react"));

var _styledComponents = _interopRequireDefault(require("styled-components"));

var _timeWidget = _interopRequireDefault(require("./filters/time-widget"));

var _animationControl = _interopRequireDefault(require("./common/animation-control/animation-control"));

var _animationController = _interopRequireDefault(require("./common/animation-control/animation-controller"));

var _defaultSettings = require("../constants/default-settings");

var _filterUtils = require("../utils/filter-utils");

var _mediaBreakpoints = require("../styles/media-breakpoints");

var _templateObject, _templateObject2;

var maxWidth = 1080;

var BottomWidgetContainer = _styledComponents["default"].div(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2["default"])(["\n  display: flex;\n  flex-direction: column;\n  padding-top: ", "px;\n  padding-right: ", "px;\n  padding-bottom: ", "px;\n  padding-left: ", "px;\n  pointer-events: none !important; /* prevent padding from blocking input */\n  & > * {\n    /* all children should allow input */\n    pointer-events: all;\n  }\n  width: ", "px;\n  z-index: 1;\n  ", "\n"])), function (props) {
  return props.hasPadding ? props.theme.bottomWidgetPaddingTop : 0;
}, function (props) {
  return props.hasPadding ? props.theme.bottomWidgetPaddingRight : 0;
}, function (props) {
  return props.hasPadding ? props.theme.bottomWidgetPaddingBottom : 0;
}, function (props) {
  return props.hasPadding ? props.theme.bottomWidgetPaddingLeft : 0;
}, function (props) {
  return props.width;
}, _mediaBreakpoints.media.portable(_templateObject2 || (_templateObject2 = (0, _taggedTemplateLiteral2["default"])(["padding: 0;"]))));

FilterAnimationControllerFactory.deps = [_animationController["default"]];

function FilterAnimationControllerFactory(AnimationController) {
  var FilterAnimationController = function FilterAnimationController(_ref) {
    var filter = _ref.filter,
        filterIdx = _ref.filterIdx,
        setFilterAnimationTime = _ref.setFilterAnimationTime,
        children = _ref.children;
    var intervalBins = (0, _react.useMemo)(function () {
      return (0, _filterUtils.getIntervalBins)(filter);
    }, [filter]);
    var steps = (0, _react.useMemo)(function () {
      return intervalBins ? intervalBins.map(function (x) {
        return x.x0;
      }) : null;
    }, [intervalBins]);
    var updateAnimation = (0, _react.useCallback)(function (value) {
      switch (filter.animationWindow) {
        case _defaultSettings.ANIMATION_WINDOW.interval:
          var idx = value[1];
          setFilterAnimationTime(filterIdx, 'value', [intervalBins[idx].x0, intervalBins[idx].x1 - 1]);
          break;

        default:
          setFilterAnimationTime(filterIdx, 'value', value);
          break;
      }
    }, [filterIdx, intervalBins, filter.animationWindow, setFilterAnimationTime]);
    return /*#__PURE__*/_react["default"].createElement(AnimationController, {
      key: "filter-control",
      value: filter.value,
      domain: filter.domain,
      speed: filter.speed,
      isAnimating: filter.isAnimating,
      animationWindow: filter.animationWindow,
      steps: steps,
      updateAnimation: updateAnimation,
      children: children
    });
  };

  return FilterAnimationController;
}

LayerAnimationControllerFactory.deps = [_animationController["default"]];

function LayerAnimationControllerFactory(AnimationController) {
  var LayerAnimationController = function LayerAnimationController(_ref2) {
    var animationConfig = _ref2.animationConfig,
        setLayerAnimationTime = _ref2.setLayerAnimationTime,
        children = _ref2.children;
    return /*#__PURE__*/_react["default"].createElement(AnimationController, {
      key: "layer-control",
      value: animationConfig.currentTime,
      domain: animationConfig.domain,
      speed: animationConfig.speed,
      isAnimating: animationConfig.isAnimating,
      updateAnimation: setLayerAnimationTime,
      steps: animationConfig.timeSteps,
      animationWindow: animationConfig.timeSteps ? _defaultSettings.ANIMATION_WINDOW.interval : _defaultSettings.ANIMATION_WINDOW.point,
      children: children
    });
  };

  return LayerAnimationController;
}

BottomWidgetFactory.deps = [_timeWidget["default"], _animationControl["default"], FilterAnimationControllerFactory, LayerAnimationControllerFactory];
/* eslint-disable complexity */

function BottomWidgetFactory(TimeWidget, AnimationControl, FilterAnimationController, LayerAnimationController) {
  var BottomWidget = function BottomWidget(props) {
    var datasets = props.datasets,
        filters = props.filters,
        animationConfig = props.animationConfig,
        visStateActions = props.visStateActions,
        containerW = props.containerW,
        uiState = props.uiState,
        sidePanelWidth = props.sidePanelWidth,
        layers = props.layers;
    var activeSidePanel = uiState.activeSidePanel,
        readOnly = uiState.readOnly;
    var isOpen = Boolean(activeSidePanel);
    var enlargedFilterIdx = (0, _react.useMemo)(function () {
      return filters.findIndex(function (f) {
        return f.enlarged && f.type === _defaultSettings.FILTER_TYPES.timeRange;
      });
    }, [filters]);
    var animatedFilterIdx = (0, _react.useMemo)(function () {
      return filters.findIndex(function (f) {
        return f.isAnimating;
      });
    }, [filters]);
    var animatedFilter = animatedFilterIdx > -1 ? filters[animatedFilterIdx] : null;
    var enlargedFilterWidth = isOpen ? containerW - sidePanelWidth : containerW; // show playback control if layers contain trip layer & at least one trip layer is visible

    var animatableLayer = (0, _react.useMemo)(function () {
      return layers.filter(function (l) {
        return l.config.animation && l.config.animation.enabled && l.config.isVisible;
      });
    }, [layers]);
    var readyToAnimation = Array.isArray(animationConfig.domain) && Number.isFinite(animationConfig.currentTime); // if animation control is showing, hide time display in time slider

    var showFloatingTimeDisplay = !animatableLayer.length;
    var showAnimationControl = animatableLayer.length && readyToAnimation && !animationConfig.hideControl;
    var showTimeWidget = enlargedFilterIdx > -1 && Object.keys(datasets).length > 0; // if filter is not animating, pass in enlarged filter here because
    // animation controller needs to call reset on it

    var filter = animatedFilter || filters[enlargedFilterIdx];
    return /*#__PURE__*/_react["default"].createElement(BottomWidgetContainer, {
      width: Math.min(maxWidth, enlargedFilterWidth),
      className: "bottom-widget--container",
      hasPadding: showAnimationControl || showTimeWidget
    }, /*#__PURE__*/_react["default"].createElement(LayerAnimationController, {
      animationConfig: animationConfig,
      setLayerAnimationTime: visStateActions.setLayerAnimationTime
    }, function (isAnimating, start, pause, reset) {
      return showAnimationControl ? /*#__PURE__*/_react["default"].createElement(AnimationControl, {
        animationConfig: animationConfig,
        setLayerAnimationTime: visStateActions.setLayerAnimationTime,
        updateAnimationSpeed: visStateActions.updateLayerAnimationSpeed,
        toggleAnimation: visStateActions.toggleLayerAnimation,
        isAnimatable: !animatedFilter,
        isAnimating: isAnimating,
        resetAnimation: reset
      }) : null;
    }), filter && /*#__PURE__*/_react["default"].createElement(FilterAnimationController, {
      filter: filter,
      filterIdx: animatedFilterIdx > -1 ? animatedFilterIdx : enlargedFilterIdx,
      setFilterAnimationTime: visStateActions.setFilterAnimationTime
    }, function (isAnimating, start, pause, resetAnimation) {
      return showTimeWidget ? /*#__PURE__*/_react["default"].createElement(TimeWidget // TimeWidget uses React.memo, here we pass width
      // even though it doesnt use it, to force rerender
      , {
        width: enlargedFilterWidth,
        filter: filters[enlargedFilterIdx],
        index: enlargedFilterIdx,
        isAnyFilterAnimating: Boolean(animatedFilter),
        datasets: datasets,
        readOnly: readOnly,
        showTimeDisplay: showFloatingTimeDisplay,
        setFilterPlot: visStateActions.setFilterPlot,
        setFilter: visStateActions.setFilter,
        setFilterAnimationTime: visStateActions.setFilterAnimationTime,
        setFilterAnimationWindow: visStateActions.setFilterAnimationWindow,
        toggleAnimation: visStateActions.toggleFilterAnimation,
        updateAnimationSpeed: visStateActions.updateFilterAnimationSpeed,
        enlargeFilter: visStateActions.enlargeFilter,
        resetAnimation: resetAnimation,
        isAnimatable: !animationConfig || !animationConfig.isAnimating
      }) : null;
    }));
  };

  return BottomWidget;
}
/* eslint-enable complexity */
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb25lbnRzL2JvdHRvbS13aWRnZXQuanMiXSwibmFtZXMiOlsibWF4V2lkdGgiLCJCb3R0b21XaWRnZXRDb250YWluZXIiLCJzdHlsZWQiLCJkaXYiLCJwcm9wcyIsImhhc1BhZGRpbmciLCJ0aGVtZSIsImJvdHRvbVdpZGdldFBhZGRpbmdUb3AiLCJib3R0b21XaWRnZXRQYWRkaW5nUmlnaHQiLCJib3R0b21XaWRnZXRQYWRkaW5nQm90dG9tIiwiYm90dG9tV2lkZ2V0UGFkZGluZ0xlZnQiLCJ3aWR0aCIsIm1lZGlhIiwicG9ydGFibGUiLCJGaWx0ZXJBbmltYXRpb25Db250cm9sbGVyRmFjdG9yeSIsImRlcHMiLCJBbmltYXRpb25Db250cm9sbGVyRmFjdG9yeSIsIkFuaW1hdGlvbkNvbnRyb2xsZXIiLCJGaWx0ZXJBbmltYXRpb25Db250cm9sbGVyIiwiZmlsdGVyIiwiZmlsdGVySWR4Iiwic2V0RmlsdGVyQW5pbWF0aW9uVGltZSIsImNoaWxkcmVuIiwiaW50ZXJ2YWxCaW5zIiwic3RlcHMiLCJtYXAiLCJ4IiwieDAiLCJ1cGRhdGVBbmltYXRpb24iLCJ2YWx1ZSIsImFuaW1hdGlvbldpbmRvdyIsIkFOSU1BVElPTl9XSU5ET1ciLCJpbnRlcnZhbCIsImlkeCIsIngxIiwiZG9tYWluIiwic3BlZWQiLCJpc0FuaW1hdGluZyIsIkxheWVyQW5pbWF0aW9uQ29udHJvbGxlckZhY3RvcnkiLCJMYXllckFuaW1hdGlvbkNvbnRyb2xsZXIiLCJhbmltYXRpb25Db25maWciLCJzZXRMYXllckFuaW1hdGlvblRpbWUiLCJjdXJyZW50VGltZSIsInRpbWVTdGVwcyIsInBvaW50IiwiQm90dG9tV2lkZ2V0RmFjdG9yeSIsIlRpbWVXaWRnZXRGYWN0b3J5IiwiQW5pbWF0aW9uQ29udHJvbEZhY3RvcnkiLCJUaW1lV2lkZ2V0IiwiQW5pbWF0aW9uQ29udHJvbCIsIkJvdHRvbVdpZGdldCIsImRhdGFzZXRzIiwiZmlsdGVycyIsInZpc1N0YXRlQWN0aW9ucyIsImNvbnRhaW5lclciLCJ1aVN0YXRlIiwic2lkZVBhbmVsV2lkdGgiLCJsYXllcnMiLCJhY3RpdmVTaWRlUGFuZWwiLCJyZWFkT25seSIsImlzT3BlbiIsIkJvb2xlYW4iLCJlbmxhcmdlZEZpbHRlcklkeCIsImZpbmRJbmRleCIsImYiLCJlbmxhcmdlZCIsInR5cGUiLCJGSUxURVJfVFlQRVMiLCJ0aW1lUmFuZ2UiLCJhbmltYXRlZEZpbHRlcklkeCIsImFuaW1hdGVkRmlsdGVyIiwiZW5sYXJnZWRGaWx0ZXJXaWR0aCIsImFuaW1hdGFibGVMYXllciIsImwiLCJjb25maWciLCJhbmltYXRpb24iLCJlbmFibGVkIiwiaXNWaXNpYmxlIiwicmVhZHlUb0FuaW1hdGlvbiIsIkFycmF5IiwiaXNBcnJheSIsIk51bWJlciIsImlzRmluaXRlIiwic2hvd0Zsb2F0aW5nVGltZURpc3BsYXkiLCJsZW5ndGgiLCJzaG93QW5pbWF0aW9uQ29udHJvbCIsImhpZGVDb250cm9sIiwic2hvd1RpbWVXaWRnZXQiLCJPYmplY3QiLCJrZXlzIiwiTWF0aCIsIm1pbiIsInN0YXJ0IiwicGF1c2UiLCJyZXNldCIsInVwZGF0ZUxheWVyQW5pbWF0aW9uU3BlZWQiLCJ0b2dnbGVMYXllckFuaW1hdGlvbiIsInJlc2V0QW5pbWF0aW9uIiwic2V0RmlsdGVyUGxvdCIsInNldEZpbHRlciIsInNldEZpbHRlckFuaW1hdGlvbldpbmRvdyIsInRvZ2dsZUZpbHRlckFuaW1hdGlvbiIsInVwZGF0ZUZpbHRlckFuaW1hdGlvblNwZWVkIiwiZW5sYXJnZUZpbHRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBb0JBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsSUFBTUEsUUFBUSxHQUFHLElBQWpCOztBQUVBLElBQU1DLHFCQUFxQixHQUFHQyw2QkFBT0MsR0FBVix3YkFHVixVQUFBQyxLQUFLO0FBQUEsU0FBS0EsS0FBSyxDQUFDQyxVQUFOLEdBQW1CRCxLQUFL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QjtBQU9FLFFBQUEsUUFBUSxFQUFFbkIsUUFQWjtBQVFFLFFBQUEsUUFBUSxFQUFFUSxRQVJaO0FBU0UsUUFBQSxlQUFlLEVBQUV3Qix1QkFUbkI7QUFVRSxRQUFBLGFBQWEsRUFBRTlCLGVBQWUsQ0FBQzZDLGFBVmpDO0FBV0UsUUFBQSxTQUFTLEVBQUU3QyxlQUFlLENBQUM4QyxTQVg3QjtBQVlFLFFBQUEsc0JBQXNCLEVBQUU5QyxlQUFlLENBQUNoQyxzQkFaMUM7QUFhRSxRQUFBLHdCQUF3QixFQUFFZ0MsZUFBZSxDQUFDK0Msd0JBYjVDO0FBY0UsUUFBQSxlQUFlLEVBQUUvQyxlQUFlLENBQUNnRCxxQkFkbkM7QUFlRSxRQUFBLG9CQUFvQixFQUFFaEQsZUFBZSxDQUFDaUQsMEJBZnhDO0FBZ0JFLFFBQUEsYUFBYSxFQUFFakQsZUFBZSxDQUFDa0QsYUFoQmpDO0FBaUJFLFFBQUEsY0FBYyxFQUFFTixjQWpCbEI7QUFrQkUsUUFBQSxZQUFZLEVBQUUsQ0FBQ3pELGVBQUQsSUFBb0IsQ0FBQ0EsZUFBZSxDQUFDSDtBQWxCckQsUUFEWSxHQXFCVixJQXRCTDtBQUFBLEtBTEgsQ0F4QkosQ0FERjtBQTBERCxHQXJHRDs7QUF1R0EsU0FBT2EsWUFBUDtBQUNEO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMjEgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQgUmVhY3QsIHt1c2VDYWxsYmFjaywgdXNlTWVtb30gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cyc7XG5pbXBvcnQgVGltZVdpZGdldEZhY3RvcnkgZnJvbSAnLi9maWx0ZXJzL3RpbWUtd2lkZ2V0JztcbmltcG9ydCBBbmltYXRpb25Db250cm9sRmFjdG9yeSBmcm9tICcuL2NvbW1vbi9hbmltYXRpb24tY29udHJvbC9hbmltYXRpb24tY29udHJvbCc7XG5pbXBvcnQgQW5pbWF0aW9uQ29udHJvbGxlckZhY3RvcnkgZnJvbSAnLi9jb21tb24vYW5pbWF0aW9uLWNvbnRyb2wvYW5pbWF0aW9uLWNvbnRyb2xsZXInO1xuaW1wb3J0IHtBTklNQVRJT05fV0lORE9XLCBGSUxURVJfVFlQRVN9IGZyb20gJ2NvbnN0YW50cy9kZWZhdWx0LXNldHRpbmdzJztcbmltcG9ydCB7Z2V0SW50ZXJ2YWxCaW5zfSBmcm9tICd1dGlscy9maWx0ZXItdXRpbHMnO1xuaW1wb3J0IHttZWRpYX0gZnJvbSAnc3R5bGVzL21lZGlhLWJyZWFrcG9pbnRzJztcblxuY29uc3QgbWF4V2lkdGggPSAxMDgwO1xuXG5jb25zdCBCb3R0b21XaWRnZXRDb250YWluZXIgPSBzdHlsZWQuZGl2YFxuICBkaXNwbGF5OiBmbGV4O1xuICBmbGV4LWRpcmVjdGlvbjogY29sdW1uO1xuICBwYWRkaW5nLXRvcDogJHtwcm9wcyA9PiAocHJvcHMuaGFzUGFkZGluZyA/IHByb3BzLnRoZW1lLmJvdHRvbVdpZGdldFBhZGRpbmdUb3AgOiAwKX1weDtcbiAgcGFkZGluZy1yaWdodDogJHtwcm9wcyA9PiAocHJvcHMuaGFzUGFkZGluZyA/IHByb3BzLnRoZW1lLmJvdHRvbVdpZGdldFBhZGRpbmdSaWdodCA6IDApfXB4O1xuICBwYWRkaW5nLWJvdHRvbTogJHtwcm9wcyA9PiAocHJvcHMuaGFzUGFkZGluZyA/IHByb3BzLnRoZW1lLmJvdHRvbVdpZGdldFBhZGRpbmdCb3R0b20gOiAwKX1weDtcbiAgcGFkZGluZy1sZWZ0OiAke3Byb3BzID0+IChwcm9wcy5oYXNQYWRkaW5nID8gcHJvcHMudGhlbWUuYm90dG9tV2lkZ2V0UGFkZGluZ0xlZnQgOiAwKX1weDtcbiAgcG9pbnRlci1ldmVudHM6IG5vbmUgIWltcG9ydGFudDsgLyogcHJldmVudCBwYWRkaW5nIGZyb20gYmxvY2tpbmcgaW5wdXQgKi9cbiAgJiA+ICoge1xuICAgIC8qIGFsbCBjaGlsZHJlbiBzaG91bGQgYWxsb3cgaW5wdXQgKi9cbiAgICBwb2ludGVyLWV2ZW50czogYWxsO1xuICB9XG4gIHdpZHRoOiAke3Byb3BzID0+IHByb3BzLndpZHRofXB4O1xuICB6LWluZGV4OiAxO1xuICAke21lZGlhLnBvcnRhYmxlYHBhZGRpbmc6IDA7YH1cbmA7XG5cbkZpbHRlckFuaW1hdGlvbkNvbnRyb2xsZXJGYWN0b3J5LmRlcHMgPSBbQW5pbWF0aW9uQ29udHJvbGxlckZhY3RvcnldO1xuZXhwb3J0IGZ1bmN0aW9uIEZpbHRlckFuaW1hdGlvbkNvbnRyb2xsZXJGYWN0b3J5KEFuaW1hdGlvbkNvbnRyb2xsZXIpIHtcbiAgY29uc3QgRmlsdGVyQW5pbWF0aW9uQ29udHJvbGxlciA9ICh7ZmlsdGVyLCBmaWx0ZXJJZHgsIHNldEZpbHRlckFuaW1hdGlvblRpbWUsIGNoaWxkcmVufSkgPT4ge1xuICAgIGNvbnN0IGludGVydmFsQmlucyA9IHVzZU1lbW8oKCkgPT4gZ2V0SW50ZXJ2YWxCaW5zKGZpbHRlciksIFtmaWx0ZXJdKTtcblxuICAgIGNvbnN0IHN0ZXBzID0gdXNlTWVtbygoKSA9PiAoaW50ZXJ2YWxCaW5zID8gaW50ZXJ2YWxCaW5zLm1hcCh4ID0+IHgueDApIDogbnVsbCksIFtcbiAgICAgIGludGVydmFsQmluc1xuICAgIF0pO1xuXG4gICAgY29uc3QgdXBkYXRlQW5pbWF0aW9uID0gdXNlQ2FsbGJhY2soXG4gICAgICB2YWx1ZSA9PiB7XG4gICAgICAgIHN3aXRjaCAoZmlsdGVyLmFuaW1hdGlvbldpbmRvdykge1xuICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX1dJTkRPVy5pbnRlcnZhbDpcbiAgICAgICAgICAgIGNvbnN0IGlkeCA9IHZhbHVlWzFdO1xuICAgICAgICAgICAgc2V0RmlsdGVyQW5pbWF0aW9uVGltZShmaWx0ZXJJZHgsICd2YWx1ZScsIFtcbiAgICAgICAgICAgICAgaW50ZXJ2YWxCaW5zW2lkeF0ueDAsXG4gICAgICAgICAgICAgIGludGVydmFsQmluc1tpZHhdLngxIC0gMVxuICAgICAgICAgICAgXSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgc2V0RmlsdGVyQW5pbWF0aW9uVGltZShmaWx0ZXJJZHgsICd2YWx1ZScsIHZhbHVlKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgW2ZpbHRlcklkeCwgaW50ZXJ2YWxCaW5zLCBmaWx0ZXIuYW5pbWF0aW9uV2luZG93LCBzZXRGaWx0ZXJBbmltYXRpb25UaW1lXVxuICAgICk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPEFuaW1hdGlvbkNvbnRyb2xsZXJcbiAgICAgICAga2V5PVwiZmlsdGVyLWNvbnRyb2xcIlxuICAgICAgICB2YWx1ZT17ZmlsdGVyLnZhbHVlfVxuICAgICAgICBkb21haW49e2ZpbHRlci5kb21haW59XG4gICAgICAgIHNwZWVkPXtmaWx0ZXIuc3BlZWR9XG4gICAgICAgIGlzQW5pbWF0aW5nPXtmaWx0ZXIuaXNBbmltYXRpbmd9XG4gICAgICAgIGFuaW1hdGlvbldpbmRvdz17ZmlsdGVyLmFuaW1hdGlvbldpbmRvd31cbiAgICAgICAgc3RlcHM9e3N0ZXBzfVxuICAgICAgICB1cGRhdGVBbmltYXRpb249e3VwZGF0ZUFuaW1hdGlvbn1cbiAgICAgICAgY2hpbGRyZW49e2NoaWxkcmVufVxuICAgICAgLz5cbiAgICApO1xuICB9O1xuICByZXR1cm4gRmlsdGVyQW5pbWF0aW9uQ29udHJvbGxlcjtcbn1cblxuTGF5ZXJBbmltYXRpb25Db250cm9sbGVyRmFjdG9yeS5kZXBzID0gW0FuaW1hdGlvbkNvbnRyb2xsZXJGYWN0b3J5XTtcbmV4cG9ydCBmdW5jdGlvbiBMYXllckFuaW1hdGlvbkNvbnRyb2xsZXJGYWN0b3J5KEFuaW1hdGlvbkNvbnRyb2xsZXIpIHtcbiAgY29uc3QgTGF5ZXJBbmltYXRpb25Db250cm9sbGVyID0gKHthbmltYXRpb25Db25maWcsIHNldExheWVyQW5pbWF0aW9uVGltZSwgY2hpbGRyZW59KSA9PiAoXG4gICAgPEFuaW1hdGlvbkNvbnRyb2xsZXJcbiAgICAgIGtleT1cImxheWVyLWNvbnRyb2xcIlxuICAgICAgdmFsdWU9e2FuaW1hdGlvbkNvbmZpZy5jdXJyZW50VGltZX1cbiAgICAgIGRvbWFpbj17YW5pbWF0aW9uQ29uZmlnLmRvbWFpbn1cbiAgICAgIHNwZWVkPXthbmltYXRpb25Db25maWcuc3BlZWR9XG4gICAgICBpc0FuaW1hdGluZz17YW5pbWF0aW9uQ29uZmlnLmlzQW5pbWF0aW5nfVxuICAgICAgdXBkYXRlQW5pbWF0aW9uPXtzZXRMYXllckFuaW1hdGlvblRpbWV9XG4gICAgICBzdGVwcz17YW5pbWF0aW9uQ29uZmlnLnRpbWVTdGVwc31cbiAgICAgIGFuaW1hdGlvbldpbmRvdz17XG4gICAgICAgIGFuaW1hdGlvbkNvbmZpZy50aW1lU3RlcHMgPyBBTklNQVRJT05fV0lORE9XLmludGVydmFsIDogQU5JTUFUSU9OX1dJTkRPVy5wb2ludFxuICAgICAgfVxuICAgICAgY2hpbGRyZW49e2NoaWxkcmVufVxuICAgIC8+XG4gICk7XG4gIHJldHVybiBMYXllckFuaW1hdGlvbkNvbnRyb2xsZXI7XG59XG5cbkJvdHRvbVdpZGdldEZhY3RvcnkuZGVwcyA9IFtcbiAgVGltZVdpZGdldEZhY3RvcnksXG4gIEFuaW1hdGlvbkNvbnRyb2xGYWN0b3J5LFxuICBGaWx0ZXJBbmltYXRpb25Db250cm9sbGVyRmFjdG9yeSxcbiAgTGF5ZXJBbmltYXRpb25Db250cm9sbGVyRmFjdG9yeVxuXTtcblxuLyogZXNsaW50LWRpc2FibGUgY29tcGxleGl0eSAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gQm90dG9tV2lkZ2V0RmFjdG9yeShcbiAgVGltZVdpZGdldCxcbiAgQW5pbWF0aW9uQ29udHJvbCxcbiAgRmlsdGVyQW5pbWF0aW9uQ29udHJvbGxlcixcbiAgTGF5ZXJBbmltYXRpb25Db250cm9sbGVyXG4pIHtcbiAgY29uc3QgQm90dG9tV2lkZ2V0ID0gcHJvcHMgPT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIGRhdGFzZXRzLFxuICAgICAgZmlsdGVycyxcbiAgICAgIGFuaW1hdGlvbkNvbmZpZyxcbiAgICAgIHZpc1N0YXRlQWN0aW9ucyxcbiAgICAgIGNvbnRhaW5lclcsXG4gICAgICB1aVN0YXRlLFxuICAgICAgc2lkZVBhbmVsV2lkdGgsXG4gICAgICBsYXllcnNcbiAgICB9ID0gcHJvcHM7XG5cbiAgICBjb25zdCB7YWN0aXZlU2lkZVBhbmVsLCByZWFkT25seX0gPSB1aVN0YXRlO1xuICAgIGNvbnN0IGlzT3BlbiA9IEJvb2xlYW4oYWN0aXZlU2lkZVBhbmVsKTtcblxuICAgIGNvbnN0IGVubGFyZ2VkRmlsdGVySWR4ID0gdXNlTWVtbyhcbiAgICAgICgpID0+IGZpbHRlcnMuZmluZEluZGV4KGYgPT4gZi5lbmxhcmdlZCAmJiBmLnR5cGUgPT09IEZJTFRFUl9UWVBFUy50aW1lUmFuZ2UpLFxuICAgICAgW2ZpbHRlcnNdXG4gICAgKTtcbiAgICBjb25zdCBhbmltYXRlZEZpbHRlcklkeCA9IHVzZU1lbW8oKCkgPT4gZmlsdGVycy5maW5kSW5kZXgoZiA9PiBmLmlzQW5pbWF0aW5nKSwgW2ZpbHRlcnNdKTtcbiAgICBjb25zdCBhbmltYXRlZEZpbHRlciA9IGFuaW1hdGVkRmlsdGVySWR4ID4gLTEgPyBmaWx0ZXJzW2FuaW1hdGVkRmlsdGVySWR4XSA6IG51bGw7XG5cbiAgICBjb25zdCBlbmxhcmdlZEZpbHRlcldpZHRoID0gaXNPcGVuID8gY29udGFpbmVyVyAtIHNpZGVQYW5lbFdpZHRoIDogY29udGFpbmVyVztcblxuICAgIC8vIHNob3cgcGxheWJhY2sgY29udHJvbCBpZiBsYXllcnMgY29udGFpbiB0cmlwIGxheWVyICYgYXQgbGVhc3Qgb25lIHRyaXAgbGF5ZXIgaXMgdmlzaWJsZVxuICAgIGNvbnN0IGFuaW1hdGFibGVMYXllciA9IHVzZU1lbW8oXG4gICAgICAoKSA9PlxuICAgICAgICBsYXllcnMuZmlsdGVyKGwgPT4gbC5jb25maWcuYW5pbWF0aW9uICYmIGwuY29uZmlnLmFuaW1hdGlvbi5lbmFibGVkICYmIGwuY29uZmlnLmlzVmlzaWJsZSksXG4gICAgICBbbGF5ZXJzXVxuICAgICk7XG5cbiAgICBjb25zdCByZWFkeVRvQW5pbWF0aW9uID1cbiAgICAgIEFycmF5LmlzQXJyYXkoYW5pbWF0aW9uQ29uZmlnLmRvbWFpbikgJiYgTnVtYmVyLmlzRmluaXRlKGFuaW1hdGlvbkNvbmZpZy5jdXJyZW50VGltZSk7XG4gICAgLy8gaWYgYW5pbWF0aW9uIGNvbnRyb2wgaXMgc2hvd2luZywgaGlkZSB0aW1lIGRpc3BsYXkgaW4gdGltZSBzbGlkZXJcbiAgICBjb25zdCBzaG93RmxvYXRpbmdUaW1lRGlzcGxheSA9ICFhbmltYXRhYmxlTGF5ZXIubGVuZ3RoO1xuICAgIGNvbnN0IHNob3dBbmltYXRpb25Db250cm9sID1cbiAgICAgIGFuaW1hdGFibGVMYXllci5sZW5ndGggJiYgcmVhZHlUb0FuaW1hdGlvbiAmJiAhYW5pbWF0aW9uQ29uZmlnLmhpZGVDb250cm9sO1xuICAgIGNvbnN0IHNob3dUaW1lV2lkZ2V0ID0gZW5sYXJnZWRGaWx0ZXJJZHggPiAtMSAmJiBPYmplY3Qua2V5cyhkYXRhc2V0cykubGVuZ3RoID4gMDtcblxuICAgIC8vIGlmIGZpbHRlciBpcyBub3QgYW5pbWF0aW5nLCBwYXNzIGluIGVubGFyZ2VkIGZpbHRlciBoZXJlIGJlY2F1c2VcbiAgICAvLyBhbmltYXRpb24gY29udHJvbGxlciBuZWVkcyB0byBjYWxsIHJlc2V0IG9uIGl0XG4gICAgY29uc3QgZmlsdGVyID0gYW5pbWF0ZWRGaWx0ZXIgfHwgZmlsdGVyc1tlbmxhcmdlZEZpbHRlcklkeF07XG5cbiAgICByZXR1cm4gKFxuICAgICAgPEJvdHRvbVdpZGdldENvbnRhaW5lclxuICAgICAgICB3aWR0aD17TWF0aC5taW4obWF4V2lkdGgsIGVubGFyZ2VkRmlsdGVyV2lkdGgpfVxuICAgICAgICBjbGFzc05hbWU9XCJib3R0b20td2lkZ2V0LS1jb250YWluZXJcIlxuICAgICAgICBoYXNQYWRkaW5nPXtzaG93QW5pbWF0aW9uQ29udHJvbCB8fCBzaG93VGltZVdpZGdldH1cbiAgICAgID5cbiAgICAgICAgPExheWVyQW5pbWF0aW9uQ29udHJvbGxlclxuICAgICAgICAgIGFuaW1hdGlvbkNvbmZpZz17YW5pbWF0aW9uQ29uZmlnfVxuICAgICAgICAgIHNldExheWVyQW5pbWF0aW9uVGltZT17dmlzU3RhdGVBY3Rpb25zLnNldExheWVyQW5pbWF0aW9uVGltZX1cbiAgICAgICAgPlxuICAgICAgICAgIHsoaXNBbmltYXRpbmcsIHN0YXJ0LCBwYXVzZSwgcmVzZXQpID0+XG4gICAgICAgICAgICBzaG93QW5pbWF0aW9uQ29udHJvbCA/IChcbiAgICAgICAgICAgICAgPEFuaW1hdGlvbkNvbnRyb2xcbiAgICAgICAgICAgICAgICBhbmltYXRpb25Db25maWc9e2FuaW1hdGlvbkNvbmZpZ31cbiAgICAgICAgICAgICAgICBzZXRMYXllckFuaW1hdGlvblRpbWU9e3Zpc1N0YXRlQWN0aW9ucy5zZXRMYXllckFuaW1hdGlvblRpbWV9XG4gICAgICAgICAgICAgICAgdXBkYXRlQW5pbWF0aW9uU3BlZWQ9e3Zpc1N0YXRlQWN0aW9ucy51cGRhdGVMYXllckFuaW1hdGlvblNwZWVkfVxuICAgICAgICAgICAgICAgIHRvZ2dsZUFuaW1hdGlvbj17dmlzU3RhdGVBY3Rpb25zLnRvZ2dsZUxheWVyQW5pbWF0aW9ufVxuICAgICAgICAgICAgICAgIGlzQW5pbWF0YWJsZT17IWFuaW1hdGVkRmlsdGVyfVxuICAgICAgICAgICAgICAgIGlzQW5pbWF0aW5nPXtpc0FuaW1hdGluZ31cbiAgICAgICAgICAgICAgICByZXNldEFuaW1hdGlvbj17cmVzZXR9XG4gICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICApIDogbnVsbFxuICAgICAgICAgIH1cbiAgICAgICAgPC9MYXllckFuaW1hdGlvbkNvbnRyb2xsZXI+XG4gICAgICAgIHtmaWx0ZXIgJiYgKFxuICAgICAgICAgIDxGaWx0ZXJBbmltYXRpb25Db250cm9sbGVyXG4gICAgICAgICAgICBmaWx0ZXI9e2ZpbHRlcn1cbiAgICAgICAgICAgIGZpbHRlcklkeD17YW5pbWF0ZWRGaWx0ZXJJZHggPiAtMSA/IGFuaW1hdGVkRmlsdGVySWR4IDogZW5sYXJnZWRGaWx0ZXJJZHh9XG4gICAgICAgICAgICBzZXRGaWx0ZXJBbmltYXRpb25UaW1lPXt2aXNTdGF0ZUFjdGlvbnMuc2V0RmlsdGVyQW5pbWF0aW9uVGltZX1cbiAgICAgICAgICA+XG4gICAgICAgICAgICB7KGlzQW5pbWF0aW5nLCBzdGFydCwgcGF1c2UsIHJlc2V0QW5pbWF0aW9uKSA9PlxuICAgICAgICAgICAgICBzaG93VGltZVdpZGdldCA/IChcbiAgICAgICAgICAgICAgICA8VGltZVdpZGdldFxuICAgICAgICAgICAgICAgICAgLy8gVGltZVdpZGdldCB1c2VzIFJlYWN0Lm1lbW8sIGhlcmUgd2UgcGFzcyB3aWR0aFxuICAgICAgICAgICAgICAgICAgLy8gZXZlbiB0aG91Z2ggaXQgZG9lc250IHVzZSBpdCwgdG8gZm9yY2UgcmVyZW5kZXJcbiAgICAgICAgICAgICAgICAgIHdpZHRoPXtlbmxhcmdlZEZpbHRlcldpZHRofVxuICAgICAgICAgICAgICAgICAgZmlsdGVyPXtmaWx0ZXJzW2VubGFyZ2VkRmlsdGVySWR4XX1cbiAgICAgICAgICAgICAgICAgIGluZGV4PXtlbmxhcmdlZEZpbHRlcklkeH1cbiAgICAgICAgICAgICAgICAgIGlzQW55RmlsdGVyQW5pbWF0aW5nPXtCb29sZWFuKGFuaW1hdGVkRmlsdGVyKX1cbiAgICAgICAgICAgICAgICAgIGRhdGFzZXRzPXtkYXRhc2V0c31cbiAgICAgICAgICAgICAgICAgIHJlYWRPbmx5PXtyZWFkT25seX1cbiAgICAgICAgICAgICAgICAgIHNob3dUaW1lRGlzcGxheT17c2hvd0Zsb2F0aW5nVGltZURpc3BsYXl9XG4gICAgICAgICAgICAgICAgICBzZXRGaWx0ZXJQbG90PXt2aXNTdGF0ZUFjdGlvbnMuc2V0RmlsdGVyUGxvdH1cbiAgICAgICAgICAgICAgICAgIHNldEZpbHRlcj17dmlzU3RhdGVBY3Rpb25zLnNldEZpbHRlcn1cbiAgICAgICAgICAgICAgICAgIHNldEZpbHRlckFuaW1hdGlvblRpbWU9e3Zpc1N0YXRlQWN0aW9ucy5zZXRGaWx0ZXJBbmltYXRpb25UaW1lfVxuICAgICAgICAgICAgICAgICAgc2V0RmlsdGVyQW5pbWF0aW9uV2luZG93PXt2aXNTdGF0ZUFjdGlvbnMuc2V0RmlsdGVyQW5pbWF0aW9uV2luZG93fVxuICAgICAgICAgICAgICAgICAgdG9nZ2xlQW5pbWF0aW9uPXt2aXNTdGF0ZUFjdGlvbnMudG9nZ2xlRmlsdGVyQW5pbWF0aW9ufVxuICAgICAgICAgICAgICAgICAgdXBkYXRlQW5pbWF0aW9uU3BlZWQ9e3Zpc1N0YXRlQWN0aW9ucy51cGRhdGVGaWx0ZXJBbmltYXRpb25TcGVlZH1cbiAgICAgICAgICAgICAgICAgIGVubGFyZ2VGaWx0ZXI9e3Zpc1N0YXRlQWN0aW9ucy5lbmxhcmdlRmlsdGVyfVxuICAgICAgICAgICAgICAgICAgcmVzZXRBbmltYXRpb249e3Jlc2V0QW5pbWF0aW9ufVxuICAgICAgICAgICAgICAgICAgaXNBbmltYXRhYmxlPXshYW5pbWF0aW9uQ29uZmlnIHx8ICFhbmltYXRpb25Db25maWcuaXNBbmltYXRpbmd9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgKSA6IG51bGxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICA8L0ZpbHRlckFuaW1hdGlvbkNvbnRyb2xsZXI+XG4gICAgICAgICl9XG4gICAgICA8L0JvdHRvbVdpZGdldENvbnRhaW5lcj5cbiAgICApO1xuICB9O1xuXG4gIHJldHVybiBCb3R0b21XaWRnZXQ7XG59XG4vKiBlc2xpbnQtZW5hYmxlIGNvbXBsZXhpdHkgKi9cbiJdfQ==